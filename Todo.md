### Todo Check

#### Plan

- [ ] Looking for next jobs :)  

      
- [ ] J.TEST A-C Level  
      (Entry till 12/13 | On 01/12)
- [ ] JLPT N1 Level
- [ ] Kanji Test

---
```
/*!!!!!!!!!!!註解還沒寫!!!!!!!!!!!!!!!!
而且你邏輯一定有問題 再檢查!!!!!!!!!!!!!*/

--TODO
-- 1. JQ COLUMN CHECK
-- 2. PK COLUMN CHECK
-- 3. 刪掉重複CTE
-- 4. OUTPUT INTO ##TMP TABLES
-- 5. EXCEL 整理+改名(TMP|CTE|VARIABLES)
-- 6. 考慮接##WHOLE_USERS


-- Steps:
-- 1. 交易明細中每個帳號最早的交易時間
-- 2. 所有數位帳戶，開戶時間在交易區間
-- 3. 結合兩表計算開戶後第一次操作時間


/* ---------------------------------------------MMANTFXJQ------------------------------------------------ */
/* -----------------------------------------[台幣帳戶|外幣帳戶]------------------------------------------- */

;WITH ACCT_FIRSTTRANS_DATE AS(
	SELECT DISTINCT MIN(TIMESTAMP) AS TRANSTIME,
		   CUSTID AS CUSTID,
		   DEDUCTIONACCT AS DEBITACCT
	FROM [FZSRD_BD].[dbo].[MMANTFXJQ]
	WHERE RSPCODE = 'SUCCESS'
	GROUP BY CUSTID, DEDUCTIONACCT)

,ACCT_FIRSTTRANS_RECORD_JQ AS(
	SELECT A.*
	FROM [FZSRD_BD].[dbo].[MMANTFXJQ] AS A
	INNER JOIN ACCT_FIRSTTRANS_DATE AS B ON A.TIMESTAMP = B.TRANSTIME
		   AND A.CUSTID = B.CUSTID
		   AND A.DEDUCTIONACCT = B.DEBITACCT)

,DIGIT_ACCT_INRANGE AS(
	SELECT *
	FROM ##WHOLE_USERS
	WHERE 數帳標記 IS NOT NULL
	AND 帳號開戶時間 BETWEEN (SELECT MIN(TRANSTIME) FROM ACCT_FIRSTTRANS_DATE) 
						AND (SELECT MAX(TRANSTIME) FROM ACCT_FIRSTTRANS_DATE))

,JQ_ACCT_TRANS_RECORD_MERGE AS(
	SELECT DISTINCT A.資料日期 AS DATADATE,
		A.用戶ID AS ID,
		A.帳號 AS ACCT,
		A.帳號開戶時間 AS ACCT_OPENING_DATE,
		A.數帳標記 AS DG_FG,
		A.幣別 AS ACCT_CUR,
		A.網銀用戶標記 AS MMA_FG,
		A.用戶網銀狀況 AS MMA_ACCT_STATUS,
		CONVERT(VARCHAR, B.TRANSTIME, 112) AS FIRST_TRANS_OPTIME,
		DATEDIFF(DAY, A.帳號開戶時間, B.TRANSTIME) AS OPENING_TO_OPTIME,
		C.PAYEECURRENCY AS FIRST_OP_PAYEE_CUR,
		C.TOTALNTAMOUNT AS FIRST_OP_PAYMENT_TWD,
		C.SOURCE AS FIRST_OP_SOURCE


	FROM DIGIT_ACCT_INRANGE AS A
	INNER JOIN ACCT_FIRSTTRANS_DATE AS B ON A.用戶ID = B.CUSTID
		   AND A.帳號 = B.DEBITACCT
	INNER JOIN ACCT_FIRSTTRANS_RECORD_JQ AS C ON B.TRANSTIME = C.TIMESTAMP
		   AND C.CUSTID = B.CUSTID
		   AND C.DEDUCTIONACCT = B.DEBITACCT)

--SELECT COUNT(*) FROM ACCT_FIRSTTRANS_DATE
--SELECT COUNT(*) FROM DIGIT_ACCT_INRANGE
SELECT * FROM JQ_ACCT_TRANS_RECORD_MERGE ORDER BY ID

/* ------------------------------------------------------------------------------------------------------ */



/* ---------------------------------------------MMANTFXPK------------------------------------------------ */
/* ---------------------------------------------[台幣帳戶]----------------------------------------------- */

;WITH ACCT_FIRSTTRANS_DATE AS(
	SELECT DISTINCT MIN(TIMESTAMP) AS TRANSTIME,
		   CUSTID AS CUSTID,
		   DEBITACCT AS DEBITACCT
	FROM [FZSRD_BD].[dbo].[MMANTFXPK]
	WHERE RSPCODE = 'SUCCESS'
	GROUP BY CUSTID, DEBITACCT)

,ACCT_FIRSTTRANS_RECORD_PK AS(
	SELECT A.*
	FROM [FZSRD_BD].[dbo].[MMANTFXPK] AS A
	INNER JOIN ACCT_FIRSTTRANS_DATE AS B ON A.TIMESTAMP = B.TRANSTIME
		   AND A.CUSTID = B.CUSTID
		   AND A.DEBITACCT = B.DEBITACCT)

,DIGIT_ACCT_INRANGE AS(
	SELECT *
	FROM ##WHOLE_USERS
	WHERE 數帳標記 IS NOT NULL
	AND 帳號開戶時間 BETWEEN (SELECT MIN(TRANSTIME) FROM ACCT_FIRSTTRANS_DATE) 
						AND (SELECT MAX(TRANSTIME) FROM ACCT_FIRSTTRANS_DATE))

,PK_ACCT_TRANS_RECORD_MERGE AS(
	SELECT DISTINCT A.資料日期 AS DATADATE,
		A.用戶ID AS ID,
		A.帳號 AS ACCT,
		A.帳號開戶時間 AS ACCT_OPENING_DATE,
		A.數帳標記 AS DG_FG,
		A.幣別 AS ACCT_CUR,
		A.網銀用戶標記 AS MMA_FG,
		A.用戶網銀狀況 AS MMA_ACCT_STATUS,
		CONVERT(VARCHAR, B.TRANSTIME, 112) AS FIRST_TRANS,
		DATEDIFF(DAY, A.帳號開戶時間, B.TRANSTIME) AS OPENING_TO_OPTIME,
		C.OTHERBANKID AS FIRST_OP_OTHERBANK,
		CAST(C.TRANSAMT AS FLOAT) AS FIRST_OP_AMT,
		CAST(C.FEE AS FLOAT) AS FIRST_OP_FEE,
		C.SOURCE AS FIRST_OP_SOURCE


	FROM DIGIT_ACCT_INRANGE AS A
	INNER JOIN ACCT_FIRSTTRANS_DATE AS B ON A.用戶ID = B.CUSTID
		   AND A.帳號 = B.DEBITACCT
	INNER JOIN ACCT_FIRSTTRANS_RECORD_PK AS C ON B.TRANSTIME = C.TIMESTAMP
		   AND C.CUSTID = B.CUSTID
		   AND C.DEBITACCT = B.DEBITACCT)

--SELECT COUNT(*) FROM ACCT_FIRSTTRANS_DATE
--SELECT COUNT(*) FROM DIGIT_ACCT_INRANGE
SELECT * FROM PK_ACCT_TRANS_RECORD_MERGE ORDER BY ID, ACCT, FIRST_OP_OTHERBANK
```
